<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand">Portfolio Management</a>
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 justify-content-end">
                <li class="nav-item">
                    <a class="nav-link active" href="dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="stockList.html">Stocks</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="">News</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="extractingbeta.html">Portfolio</a>
                </li>
            </ul>
            <form class="d-flex" role="search">
                <input id="searchInput" class="form-control me-2" type="search" placeholder="Search"
                    aria-label="Search">
                <button id="search" class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </div>
    </nav>

    <div class="container text-center">
        <div class="container">
            <!-- Display the selected stock symbol -->
            <h1 id="stockSymbol"></h1>
        </div>

        <div class="container" id="indices-buttons">
            <div class="row justify-content-start">
                <div class="col-3">
                    <button id="snp500">S&P 500</button>
                    <button id="nasdaq100">Nasdaq 100</button>
                    <button id="dow30">Dow 30</button>
                </div>
            </div>
        </div>

        <div class="container" id="candlestick-chart">
            <!-- The candlestick chart will be rendered here -->
        </div>

        <div class="container">
            <div class="row justify-content-between">
                <div class="col-3" id="interval-options">
                    <button id="allButton">All time</button>
                    <button id="1m">1 month</button>
                    <button id="1wk">1 week</button>
                </div>
                <div class="col-3" id="chart-type">
                    <button id="candlestick">Candlestick</button>
                    <button id="area">Area</button>
                </div>
            </div>
        </div>

        <div class="container" id="trending-container">
            <!-- This will hold trending, most active and top gainer stocks -->
            <div id="trending"></div>
            <div id="active"></div>
            <div id="gainer"></div>
        </div>
    </div>

    <script>
        // Initialize chart to null
        var chart = null;

        // Get the selected stock symbol from the URL parameter
        var selectedSymbol = '';

        // Default chart type is candlestick, user can switch between area and candlestick
        var chartType = 'candlestick';

        // Display the selected symbol and default period on the page
        document.getElementById('stockSymbol').textContent = `Stock Symbol: ${selectedSymbol} (Daily)`;

        // Clear existing charts and create a new one
        async function renderChart(chartData) {
            if (chart) {
                chart.destroy(); // Clear current chart
            }

            const chartOptions = {
                chart: {
                    type: chartType,
                    height: 400,
                    width: 1200
                },
                series: [
                    {
                        data: chartData,
                    },
                ],
                xaxis: {
                    type: 'datetime',
                },
                yaxis: {
                    tooltip: {
                        enabled: true
                    }
                },
                dataLabels: {
                    enabled: false
                }
            };

            // Render the chart
            chart = new ApexCharts(document.querySelector('#candlestick-chart'), chartOptions);
            chart.render();
        }

        // Fetch data from yahoo finance using rapidapi
        async function fetchData(interval, symbol = selectedSymbol) {
            let historical_data = {
                method: 'GET',
                url: 'https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v3/get-historical-data',
                params: {
                    symbol: symbol,
                    region: 'US'
                },
                headers: {
                    'X-RapidAPI-Key': '0f41b9c6a4mshb99c3841f59207ap13d9c1jsn36a3f1207f00',
                    'X-RapidAPI-Host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
                }
            };

            let quotes = {
                method: 'GET',
                url: 'https://apidojo-yahoo-finance-v1.p.rapidapi.com/market/v2/get-quotes',
                params: {
                    region: 'US',
                    symbols: symbol,
                },
                headers: {
                    'X-RapidAPI-Key': 'f033b0dff5mshf586d930d4a646ap1ef84ejsn5be27eba3a61',
                    'X-RapidAPI-Host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
                }
            };

            // Adjust the interval and period based on the button clicked
            if (interval === 'Weekly') {
                historical_data.params.period1 = Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60); // 7 days ago
            } else if (interval === 'Monthly') {
                historical_data.params.period1 = Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60); // 30 days ago
            } else {
                historical_data.params.period1 = '0';   //default at ALL
            }

            try {
                const response = await axios.request(historical_data);
                const response_quotes = await axios.request(quotes);
                const stockData = response.data;
                const quotesData = response_quotes.data;
                
                tickerName = quotesData.quoteResponse.result[0].shortName;

                // Extract the data you need for the chart from stockData
                let chartData = stockData.prices.map((price) => ({
                    x: new Date(price.date * 1000),  // Convert timestamp to Date
                    y: [price.open.toFixed(2), price.high.toFixed(2), price.low.toFixed(2), price.close.toFixed(2)]
                }));

                // Filter chartData based on the selected interval
                if (interval === 'Weekly') {
                    // Filter to include only the last 7 data points for weekly
                    chartData = chartData.slice(-7);
                } else if (interval === 'Monthly') {
                    // Filter to include only the last 30 data points for monthly
                    chartData = chartData.slice(-30);
                } else if (interval === 'All') {
                    // No need to filter for "All"
                }

                // Render the chart
                renderChart(chartData);

                // Update the displayed interval
                document.getElementById('stockSymbol').textContent = `Stock Symbol: ${tickerName} (${interval})`;
            } catch (error) {
                console.error(error);
            }
        }

        document.getElementById('snp500').addEventListener('click', () => {
            selectedSymbol = '^GSPC';
            fetchData('All');
        });
        document.getElementById('nasdaq100').addEventListener('click', () => {
            selectedSymbol = '^NDX';
            fetchData('All');
        });
        document.getElementById('dow30').addEventListener('click', () => {
            selectedSymbol = '^DJI';
            fetchData('All');
        });


        document.getElementById('1wk').addEventListener('click', () => {
            fetchData('Weekly');
        });
        document.getElementById('1m').addEventListener('click', () => {
            fetchData('Monthly');
        });
        document.getElementById('allButton').addEventListener('click', () => {
            fetchData('All');
        });

        document.getElementById('candlestick').addEventListener('click', () => {
            chartType = 'candlestick';
            fetchData('All');
        });
        document.getElementById('area').addEventListener('click', () => {
            chartType = 'area';
            fetchData('All');
        });

        window.addEventListener("load", () => {
            selectedSymbol = '^GSPC';
            fetchData('All');
        }, false);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
    <script src="trending.js"></script>
</body>

</html>